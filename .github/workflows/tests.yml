name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # ---------- BUILD ----------
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: üê≥ –°–±–æ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: |
          docker build -t selenium-tests .
          docker save selenium-tests -o selenium-tests.tar

      - name: üì¶ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (docker image)
        uses: actions/upload-artifact@v3
        with:
          name: selenium-tests
          path: selenium-tests.tar

  # ---------- TEST ----------
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3

      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ docker image
        uses: actions/download-artifact@v3
        with:
          name: selenium-tests
          path: .

      - name: ‚ñ∂ –ó–∞–ø—É—Å–∫ Selenium-—Ç–µ—Å—Ç–æ–≤
        run: |
          mkdir -p allure-results
          docker load -i selenium-tests.tar
          docker run --rm -v ${{ github.workspace }}/allure-results:/allure-results selenium-tests

      - name: üì¶ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (allure results)
        uses: actions/upload-artifact@v3
        with:
          name: allure-results
          path: allure-results

  # ---------- REPORT ----------
  allure-report:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3

      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ allure results
        uses: actions/download-artifact@v3
        with:
          name: allure-results
          path: allure-results

      - name: ‚öô –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Allure
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -xzf allure-2.27.0.tgz

      - name: üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure-–æ—Ç—á–µ—Ç–∞
        run: |
          ./allure-2.27.0/bin/allure generate allure-results --clean -o public

      - name: üì¶ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (–æ—Ç—á–µ—Ç)
        uses: actions/upload-artifact@v3
        with:
          name: allure-report
          path: public

  # ---------- DEPLOY ----------
  deploy:
    runs-on: ubuntu-latest
    needs: allure-report
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - uses: actions/download-artifact@v3
        with:
          name: allure-report
          path: public

      - name: üì§ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ GitHub Pages
        uses: actions/upload-pages-artifact@v2

  deploy-pages:
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4